name: CI (Mirror + Maven + Sonar + Buildah)

on:
  workflow_dispatch:
    inputs:
      run_all_homol:
        description: "Forçar deploy homol"
        required: false
        default: "false"
      run_all_prod:
        description: "Forçar deploy prod"
        required: false
        default: "false"
  schedule:
    - cron: "0 3 * * *" # diário 03:00 UTC

env:
  MAVEN_OPTS: ${{ vars.MAVEN_OPTS || '-Dmaven.repo.local=/home/runner/.m2/repository' }}
  PROJECT_NAME: ${{ vars.PROJECT_NAME || 'autonomy-network-flow' }}
  HOMOL_GROUP: ${{ vars.HOMOL_GROUP || 'vivo-autonomy-homol' }}
  PROD_GROUP: ${{ vars.PROD_GROUP || 'vivo-autonomy-prod' }}

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: |
      github.event_name == 'schedule' ||
      github.ref == 'refs/heads/develop' ||
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.run_all_homol == 'true' || github.event.inputs.run_all_prod == 'true'))
    permissions:
      contents: write # necessário para push no mirror
      packages: write # necessário para push de imagem em registries autenticados
    steps:
      - name: Checkout (workflow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Sincronizar repositório externo -> GitHub
        id: sync
        run: scripts/sync.sh
        env:
          EXTERNAL_REPO_URL: ${{ secrets.EXTERNAL_REPO_URL }}
          EXTERNAL_REPO_TOKEN: ${{ secrets.EXTERNAL_REPO_TOKEN }}
          EXTERNAL_REPO_BRANCH: ${{ vars.EXTERNAL_REPO_BRANCH || 'main' }}
          TARGET_BRANCH: ${{ vars.TARGET_BRANCH || 'main' }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: ci-bot
          GIT_AUTHOR_EMAIL: ci-bot@example.com

      - name: Setup JDK 8 + cache Maven
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "8"
          cache: maven

      - name: Build Maven (sem testes)
        run: mvn -B -ntp clean package -DskipTests
        working-directory: ${{ steps.sync.outputs.sync_dir }}

      - name: Capturar versão
        id: version
        run: |
          APP_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "APP_VERSION=$APP_VERSION" | tee version.txt
          echo "app_version=$APP_VERSION" >> "$GITHUB_OUTPUT"
        working-directory: ${{ steps.sync.outputs.sync_dir }}

      - name: Análise SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        run: >
          mvn -B -ntp sonar:sonar
          -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }}
          -Dsonar.organization=${{ vars.SONAR_ORG }}
          -Dsonar.host.url=${SONAR_HOST_URL}
          -Dsonar.login=${SONAR_TOKEN}
        working-directory: ${{ steps.sync.outputs.sync_dir }}

      - name: Instalar buildah
        if: |
          github.ref == 'refs/heads/develop' ||
          github.ref == 'refs/heads/main' ||
          (github.event_name == 'workflow_dispatch' && (github.event.inputs.run_all_homol == 'true' || github.event.inputs.run_all_prod == 'true'))
        run: |
          sudo apt-get update
          sudo apt-get install -y buildah

      - name: Build e push imagem (homol)
        if: |
          github.ref == 'refs/heads/develop' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all_homol == 'true')
        env:
          IMAGE_NAME: harbor.devops-vivo.telcostack.com.br/${{ env.HOMOL_GROUP }}/${{ env.PROJECT_NAME }}
          BUILDAH_ISOLATION: chroot
          STORAGE_DRIVER: vfs
          _BUILDAH_STARTED_IN_USERNS: ""
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          cd "${{ steps.sync.outputs.sync_dir }}"
          source version.txt
          echo "${HARBOR_PASSWORD}" | buildah login --username "${HARBOR_USERNAME}" --password-stdin harbor.devops-vivo.telcostack.com.br
          echo "Construindo ${IMAGE_NAME}:${APP_VERSION}"
          buildah bud -t ${IMAGE_NAME}:${APP_VERSION} .
          echo "Fazendo push ${IMAGE_NAME}:${APP_VERSION}"
          buildah push ${IMAGE_NAME}:${APP_VERSION}

      - name: Build e push imagem (prod)
        if: |
          github.ref == 'refs/heads/main' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all_prod == 'true')
        env:
          IMAGE_NAME: harbor.devops-vivo.telcostack.com.br/${{ env.PROD_GROUP }}/${{ env.PROJECT_NAME }}
          BUILDAH_ISOLATION: chroot
          STORAGE_DRIVER: vfs
          _BUILDAH_STARTED_IN_USERNS: ""
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          cd "${{ steps.sync.outputs.sync_dir }}"
          source version.txt
          echo "${HARBOR_PASSWORD}" | buildah login --username "${HARBOR_USERNAME}" --password-stdin harbor.devops-vivo.telcostack.com.br
          echo "Construindo ${IMAGE_NAME}:${APP_VERSION}"
          buildah bud -t ${IMAGE_NAME}:${APP_VERSION} .
          echo "Fazendo push ${IMAGE_NAME}:${APP_VERSION}"
          buildah push ${IMAGE_NAME}:${APP_VERSION}

